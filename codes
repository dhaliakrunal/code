package com.example.jsonreader.entity;

import jakarta.persistence.*;
import lombok.*;

@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class MergedOutputEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String crdsCode;
    private String bnppSite;
    private String siteCountry;
    private String siteStatus;
    private String kycSegment;
    private String riskIndustry;
    private String registrationAddress;
    private String registrationCountry;
}






package com.example.jsonreader.repository;

import com.example.jsonreader.entity.MergedOutputEntity;
import org.springframework.data.jpa.repository.JpaRepository;

public interface MergedOutputRepository extends JpaRepository<MergedOutputEntity, Long> {
}




package com.example.jsonreader.service;

import com.example.jsonreader.entity.MergedOutputEntity;
import com.example.jsonreader.model.MergedOutput;
import com.example.jsonreader.repository.MergedOutputRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
@RequiredArgsConstructor
public class MergedOutputPersistenceService {

    private final MergedOutputRepository repository;

    public void saveToH2Database(List<MergedOutput> mergedData) {
        List<MergedOutputEntity> entityList = mergedData.stream()
                .map(data -> MergedOutputEntity.builder()
                        .crdsCode(data.getCrdsCode())
                        .bnppSite(data.getBnppSite())
                        .siteCountry(data.getSiteCountry())
                        .siteStatus(data.getSiteStatus())
                        .kycSegment(data.getKycSegment())
                        .riskIndustry(data.getRiskIndustry())
                        .registrationAddress(data.getRegistrationAddress())
                        .registrationCountry(data.getRegistrationCountry())
                        .build())
                .toList();

        repository.saveAll(entityList);
    }
}



@GetMapping("/api/save")
public ResponseEntity<String> mergeAndSaveToDatabase() {
    List<MergedOutput> mergedData = jsonReaderService.mergeAndDisplayData();
    mergedOutputPersistenceService.saveToH2Database(mergedData);
    return ResponseEntity.ok("Merged data saved to H2 database successfully.");
}



package com.example.jsonreader.service;

import com.example.jsonreader.entity.MergedOutputEntity;
import com.example.jsonreader.model.Identifiers;
import com.example.jsonreader.model.MergedOutput;
import com.example.jsonreader.repository.MergedOutputRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
@RequiredArgsConstructor
public class MergedOutputPersistenceService {

    private final MergedOutputRepository repository;

    public void saveToH2Database(List<MergedOutput> mergedData) {
        List<MergedOutputEntity> entityList = mergedData.stream()
                .map(data -> {
                    Identifiers firstIdentifier = data.getIdentifiers() != null && !data.getIdentifiers().isEmpty()
                            ? data.getIdentifiers().get(0)
                            : new Identifiers();

                    return MergedOutputEntity.builder()
                            .crdsCode(firstIdentifier.getCrdsCode())
                            .bnppSite(firstIdentifier.getBnppSite())
                            .siteCountry(firstIdentifier.getSiteCountry())
                            .siteStatus(firstIdentifier.getSiteStatus())
                            .registrationAddress(firstIdentifier.getRegistrationAddress())
                            .registrationCountry(firstIdentifier.getRegistrationCountry())
                            .kycSegment(data.getKycSegment())
                            .riskIndustry(data.getRiskIndustry())
                            .build();
                })
                .toList();

        repository.saveAll(entityList);
    }
}
